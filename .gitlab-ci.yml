image: maven:3-openjdk-18-slim

build-job:
  stage: build
  script:
    - echo "Compiling the code..."
    - mvn clean package
    - echo "Compile complete."
  artifacts:
    paths:
      - impl/target
  tags:
    - check

deploy-job:
  image: docker:19.03.12-dind
  stage: deploy
  before_script:
    - docker logout
    - docker login -u skillgroup28 -p 5544676hen
  script:
    - docker build -t skillgroup28/server .
    - echo "Deploying application..."
    - docker push skillgroup28/server
    - echo "Application successfully deployed."
    - DOCKERID=$(docker ps --filter "ancestor=skillgroup28/server" -q);
    - echo "ID=$DOCKERID";
    - docker stop $DOCKERID;
    - echo "stopped"
    - docker pull skillgroup28/server
    - echo "pulled"
    - docker run -d -p 8090:8080 skillgroup28/server
    - echo "started"
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event'"
  artifacts:
    paths:
      - impl/target/impl-0.0.1-SNAPSHOT.jar
  tags:
    - push
